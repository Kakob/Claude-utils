{"version":3,"file":"webapp-sync.js","sources":["../extension/webapp-sync.ts"],"sourcesContent":["// Content script that runs on the localhost web app\n// Receives activities from the background and writes to the page's IndexedDB\n\ninterface StoredActivity {\n  id: string;\n  type: string;\n  source: 'claude.ai' | 'extension';\n  conversationId: string | null;\n  conversationTitle: string | null;\n  model: string | null;\n  timestamp: Date;\n  tokens: { inputTokens: number; outputTokens: number; cacheCreationTokens?: number; cacheReadTokens?: number } | null;\n  metadata: Record<string, unknown>;\n}\n\ninterface DailyStats {\n  date: string;\n  inputTokens: number;\n  outputTokens: number;\n  messageCount: number;\n  artifactCount: number;\n  toolUseCount: number;\n  modelUsage: Record<string, number>;\n}\n\nlet db: IDBDatabase | null = null;\nlet dbReady = false;\n\nasync function initDB(): Promise<IDBDatabase | null> {\n  return new Promise((resolve) => {\n    // Try to open existing database (created by Dexie in the web app)\n    const request = indexedDB.open('ClaudeUtils');\n\n    request.onerror = () => {\n      console.warn('[Claude Utils] Could not open DB:', request.error);\n      resolve(null);\n    };\n\n    request.onsuccess = () => {\n      const database = request.result;\n      const stores = Array.from(database.objectStoreNames);\n      console.log('[Claude Utils] DB opened, stores:', stores);\n\n      // Check if the activities store exists (created by Dexie v2)\n      if (!stores.includes('activities')) {\n        console.warn('[Claude Utils] activities store not found. Make sure to open the web app first to initialize the database.');\n        database.close();\n        resolve(null);\n        return;\n      }\n\n      resolve(database);\n    };\n  });\n}\n\nfunction getDateString(timestamp: number): string {\n  return new Date(timestamp).toISOString().split('T')[0];\n}\n\nasync function storeActivity(activity: StoredActivity): Promise<void> {\n  if (!db) {\n    db = await initDB();\n    if (!db) {\n      console.warn('[Claude Utils] DB not available, cannot store activity');\n      return;\n    }\n    dbReady = true;\n  }\n\n  try {\n    const transaction = db.transaction(['activities', 'dailyStats'], 'readwrite');\n\n    transaction.onerror = () => {\n      console.error('[Claude Utils] Transaction error:', transaction.error);\n    };\n\n    // Store the activity\n    const activitiesStore = transaction.objectStore('activities');\n    const addRequest = activitiesStore.add(activity);\n\n    addRequest.onerror = () => {\n      console.error('[Claude Utils] Error adding activity:', addRequest.error);\n    };\n\n    addRequest.onsuccess = () => {\n      console.log('[Claude Utils] Activity stored:', activity.type, activity.id);\n      // Dispatch custom event to notify the web app\n      window.dispatchEvent(new CustomEvent('claude-utils-activity', {\n        detail: { activity },\n      }));\n    };\n\n    // Update daily stats\n    const dateStr = getDateString(activity.timestamp.getTime());\n    const dailyStatsStore = transaction.objectStore('dailyStats');\n\n    const statsRequest = dailyStatsStore.get(dateStr);\n    statsRequest.onsuccess = () => {\n      const existing: DailyStats = statsRequest.result ?? {\n        date: dateStr,\n        inputTokens: 0,\n        outputTokens: 0,\n        messageCount: 0,\n        artifactCount: 0,\n        toolUseCount: 0,\n        modelUsage: {},\n      };\n\n      if (activity.tokens) {\n        existing.inputTokens += activity.tokens.inputTokens;\n        existing.outputTokens += activity.tokens.outputTokens;\n      }\n\n      if (activity.type === 'message_sent' || activity.type === 'message_received') {\n        existing.messageCount += 1;\n      }\n\n      if (activity.type === 'artifact_created') {\n        existing.artifactCount += 1;\n      }\n\n      if (activity.type === 'tool_use') {\n        existing.toolUseCount += 1;\n      }\n\n      if (activity.model) {\n        existing.modelUsage[activity.model] = (existing.modelUsage[activity.model] ?? 0) + 1;\n      }\n\n      dailyStatsStore.put(existing);\n    };\n  } catch (error) {\n    console.error('[Claude Utils] Error storing activity:', error);\n    // Reset db so it tries to reconnect next time\n    db = null;\n    dbReady = false;\n  }\n}\n\n// Listen for messages from background\nchrome.runtime.onMessage.addListener((message, _sender, sendResponse) => {\n  if (message.type === 'SYNC_ACTIVITY') {\n    console.log('[Claude Utils] Received activity to sync:', message.activity);\n    // Convert timestamp back to Date\n    const activity = {\n      ...message.activity,\n      timestamp: new Date(message.activity.timestamp),\n    };\n    storeActivity(activity);\n    sendResponse({ success: true });\n  }\n  return true;\n});\n\n// Signal to background that this tab is ready to receive activities\nfunction signalReady(): void {\n  try {\n    chrome.runtime.sendMessage({ type: 'WEBAPP_READY' });\n    console.log('[Claude Utils] Sent WEBAPP_READY signal to background');\n  } catch (error) {\n    console.log('[Claude Utils] Could not send ready signal:', error);\n  }\n}\n\n// Initialize DB on load\ninitDB().then((database) => {\n  if (database) {\n    db = database;\n    dbReady = true;\n    console.log('[Claude Utils] Web app sync ready');\n    signalReady();\n  } else {\n    console.log('[Claude Utils] Web app sync waiting for database (open the Timeline page first)');\n    // Still signal ready - activities can be stored once DB is available\n    signalReady();\n  }\n});\n"],"names":[],"mappings":"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"}