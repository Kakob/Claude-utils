{"version":3,"file":"background.js","sources":["../extension/background.ts"],"sourcesContent":["// Background service worker for the extension\n// Captures activities and sends them directly to the API\n\nimport type { ExtensionMessage, CapturedResponse, DOMActivity } from './types';\n\nconst API_URL = 'http://localhost:3003/api';\n\n// Conversation title cache\nconst conversationTitles = new Map<string, string>();\n\n// Generate unique ID\nfunction generateId(): string {\n  return `${Date.now()}-${Math.random().toString(36).slice(2, 11)}`;\n}\n\ntype ActivityPayload = {\n  id: string;\n  type: string;\n  source: 'extension';\n  conversationId: string | null;\n  conversationTitle: string | null;\n  model: string | null;\n  timestamp: Date;\n  tokens: { inputTokens: number; outputTokens: number; cacheCreationTokens?: number; cacheReadTokens?: number } | null;\n  metadata: Record<string, unknown>;\n};\n\n// Send activity directly to the API\nasync function syncActivity(activity: ActivityPayload): Promise<void> {\n  console.log('[Claude Utils] Sending activity to API:', activity.type, activity.id);\n\n  try {\n    const response = await fetch(`${API_URL}/activities`, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        ...activity,\n        timestamp: activity.timestamp.toISOString(),\n      }),\n    });\n\n    if (!response.ok) {\n      throw new Error(`API error: ${response.status}`);\n    }\n\n    console.log('[Claude Utils] Activity stored:', activity.type, activity.id);\n\n    // Notify any open web app tabs for live UI updates\n    notifyWebAppTabs(activity);\n  } catch (error) {\n    console.error('[Claude Utils] Error sending activity to API:', error);\n  }\n}\n\n// Best-effort notify open web app tabs for live UI refresh\nasync function notifyWebAppTabs(activity: ActivityPayload): Promise<void> {\n  try {\n    const tabs = await chrome.tabs.query({\n      url: ['http://localhost:*/*', 'http://127.0.0.1:*/*'],\n    });\n\n    for (const tab of tabs) {\n      if (tab.id) {\n        chrome.tabs.sendMessage(tab.id, {\n          type: 'ACTIVITY_STORED',\n          activity: { ...activity, timestamp: activity.timestamp.toISOString() },\n        }).catch(() => { /* tab not listening, that's fine */ });\n      }\n    }\n  } catch {\n    // No tabs open, that's fine\n  }\n}\n\n// Process captured API response\nfunction processResponse(data: CapturedResponse): void {\n  const conversationTitle = data.conversationId\n    ? conversationTitles.get(data.conversationId) ?? null\n    : null;\n\n  // Only track completion requests (actual messages)\n  if (!data.url.includes('/completion')) {\n    return;\n  }\n\n  const activity = {\n    id: generateId(),\n    type: 'message_received',\n    source: 'extension' as const,\n    conversationId: data.conversationId ?? null,\n    conversationTitle,\n    model: data.model ?? null,\n    timestamp: new Date(data.timestamp),\n    tokens: data.tokens ?? null,\n    metadata: {\n      messageRole: 'assistant' as const,\n      messagePreview: data.messagePreview,\n      fullContent: data.fullContent,\n      userMessage: data.userMessage,\n    },\n  };\n\n  syncActivity(activity);\n}\n\n// Process DOM activity\nfunction processDOMActivity(data: DOMActivity): void {\n  const conversationId = getCurrentConversationId();\n  const conversationTitle = conversationId\n    ? conversationTitles.get(conversationId) ?? null\n    : null;\n\n  let activityType: string;\n  const metadata: Record<string, unknown> = {};\n\n  switch (data.type) {\n    case 'artifact':\n      activityType = 'artifact_created';\n      metadata.artifactTitle = data.title;\n      metadata.artifactType = data.artifactType;\n      break;\n    case 'code_block':\n      activityType = 'code_block';\n      metadata.codeLanguage = data.language;\n      metadata.codeContent = data.codeContent;\n      break;\n    case 'tool_use':\n      activityType = 'tool_use';\n      metadata.toolName = data.toolName;\n      break;\n    case 'tool_result':\n      activityType = 'tool_result';\n      metadata.toolName = data.toolName;\n      break;\n    default:\n      return;\n  }\n\n  const activity = {\n    id: generateId(),\n    type: activityType,\n    source: 'extension' as const,\n    conversationId,\n    conversationTitle,\n    model: null,\n    timestamp: new Date(data.timestamp),\n    tokens: null,\n    metadata,\n  };\n\n  syncActivity(activity);\n}\n\n// Track current conversation\nlet currentConversationId: string | null = null;\n\nfunction getCurrentConversationId(): string | null {\n  return currentConversationId;\n}\n\n// Handle messages from content script\nchrome.runtime.onMessage.addListener((message: ExtensionMessage, sender) => {\n  console.log('[Claude Utils] Background received message:', message.type);\n\n  // Extract conversation ID from tab URL\n  if (sender.tab?.url) {\n    const match = sender.tab.url.match(/\\/chat\\/([^/?]+)/);\n    if (match) {\n      currentConversationId = match[1];\n    }\n  }\n\n  switch (message.type) {\n    case 'CLAUDE_RESPONSE':\n      processResponse(message.data);\n      break;\n    case 'DOM_ACTIVITY':\n      processDOMActivity(message.data);\n      break;\n    case 'CONVERSATION_TITLE':\n      conversationTitles.set(message.data.conversationId, message.data.title);\n      break;\n  }\n});\n\nconsole.log('[Claude Utils] Background service worker initialized');\n"],"names":[],"mappings":"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"}