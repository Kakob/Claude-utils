{"version":3,"file":"background.js","sources":["../extension/background.ts"],"sourcesContent":["// Background service worker for the extension\n// Captures activities and syncs them to the web app's IndexedDB\n\nimport type { ExtensionMessage, CapturedResponse, DOMActivity } from './types';\n\n// Conversation title cache\nconst conversationTitles = new Map<string, string>();\n\n// Queue for activities that couldn't be delivered\nconst pendingActivities: Array<{\n  id: string;\n  type: string;\n  source: 'extension';\n  conversationId: string | null;\n  conversationTitle: string | null;\n  model: string | null;\n  timestamp: Date;\n  tokens: { inputTokens: number; outputTokens: number; cacheCreationTokens?: number; cacheReadTokens?: number } | null;\n  metadata: Record<string, unknown>;\n}> = [];\n\n// Track ready web app tabs\nconst readyTabs = new Set<number>();\n\n// Generate unique ID\nfunction generateId(): string {\n  return `${Date.now()}-${Math.random().toString(36).slice(2, 11)}`;\n}\n\ntype ActivityPayload = {\n  id: string;\n  type: string;\n  source: 'extension';\n  conversationId: string | null;\n  conversationTitle: string | null;\n  model: string | null;\n  timestamp: Date;\n  tokens: { inputTokens: number; outputTokens: number; cacheCreationTokens?: number; cacheReadTokens?: number } | null;\n  metadata: Record<string, unknown>;\n};\n\n// Find web app tabs and sync activity to them\nasync function syncActivityToWebApp(activity: ActivityPayload): Promise<void> {\n  console.log('[Claude Utils] Syncing activity to web app:', activity);\n\n  try {\n    // Find all localhost tabs (where the web app runs)\n    const tabs = await chrome.tabs.query({\n      url: ['http://localhost:*/*', 'http://127.0.0.1:*/*'],\n    });\n\n    if (tabs.length === 0) {\n      console.log('[Claude Utils] No web app tabs found, queuing activity');\n      pendingActivities.push(activity);\n      return;\n    }\n\n    let delivered = false;\n\n    // Send to all matching tabs that are ready\n    for (const tab of tabs) {\n      if (tab.id && readyTabs.has(tab.id)) {\n        try {\n          await chrome.tabs.sendMessage(tab.id, {\n            type: 'SYNC_ACTIVITY',\n            activity: {\n              ...activity,\n              timestamp: activity.timestamp.toISOString(),\n            },\n          });\n          console.log('[Claude Utils] Activity sent to tab:', tab.id);\n          delivered = true;\n        } catch (error) {\n          // Tab might have been closed or refreshed\n          console.log('[Claude Utils] Could not send to tab:', tab.id, error);\n          readyTabs.delete(tab.id);\n        }\n      }\n    }\n\n    // If no ready tabs, queue the activity\n    if (!delivered) {\n      console.log('[Claude Utils] No ready tabs, queuing activity');\n      pendingActivities.push(activity);\n    }\n  } catch (error) {\n    console.error('[Claude Utils] Error syncing activity:', error);\n    pendingActivities.push(activity);\n  }\n}\n\n// Flush pending activities to a newly ready tab\nasync function flushPendingActivities(tabId: number): Promise<void> {\n  if (pendingActivities.length === 0) return;\n\n  console.log('[Claude Utils] Flushing', pendingActivities.length, 'pending activities to tab:', tabId);\n\n  const toFlush = [...pendingActivities];\n  pendingActivities.length = 0;\n\n  for (const activity of toFlush) {\n    try {\n      await chrome.tabs.sendMessage(tabId, {\n        type: 'SYNC_ACTIVITY',\n        activity: {\n          ...activity,\n          timestamp: activity.timestamp.toISOString(),\n        },\n      });\n      console.log('[Claude Utils] Flushed activity:', activity.id);\n    } catch (error) {\n      console.log('[Claude Utils] Failed to flush activity:', activity.id, error);\n      // Put it back in queue\n      pendingActivities.push(activity);\n    }\n  }\n}\n\n// Process captured API response\nfunction processResponse(data: CapturedResponse): void {\n  const conversationTitle = data.conversationId\n    ? conversationTitles.get(data.conversationId) ?? null\n    : null;\n\n  // Only track completion requests (actual messages)\n  if (!data.url.includes('/completion')) {\n    return;\n  }\n\n  const activity = {\n    id: generateId(),\n    type: 'message_received',\n    source: 'extension' as const,\n    conversationId: data.conversationId ?? null,\n    conversationTitle,\n    model: data.model ?? null,\n    timestamp: new Date(data.timestamp),\n    tokens: data.tokens ?? null,\n    metadata: {\n      messageRole: 'assistant' as const,\n      messagePreview: data.messagePreview,\n      fullContent: data.fullContent,\n      userMessage: data.userMessage,\n    },\n  };\n\n  syncActivityToWebApp(activity);\n}\n\n// Process DOM activity\nfunction processDOMActivity(data: DOMActivity): void {\n  const conversationId = getCurrentConversationId();\n  const conversationTitle = conversationId\n    ? conversationTitles.get(conversationId) ?? null\n    : null;\n\n  let activityType: string;\n  const metadata: Record<string, unknown> = {};\n\n  switch (data.type) {\n    case 'artifact':\n      activityType = 'artifact_created';\n      metadata.artifactTitle = data.title;\n      metadata.artifactType = data.artifactType;\n      break;\n    case 'code_block':\n      activityType = 'code_block';\n      metadata.codeLanguage = data.language;\n      metadata.codeContent = data.codeContent;\n      break;\n    case 'tool_use':\n      activityType = 'tool_use';\n      metadata.toolName = data.toolName;\n      break;\n    case 'tool_result':\n      activityType = 'tool_result';\n      metadata.toolName = data.toolName;\n      break;\n    default:\n      return;\n  }\n\n  const activity = {\n    id: generateId(),\n    type: activityType,\n    source: 'extension' as const,\n    conversationId,\n    conversationTitle,\n    model: null,\n    timestamp: new Date(data.timestamp),\n    tokens: null,\n    metadata,\n  };\n\n  syncActivityToWebApp(activity);\n}\n\n// Track current conversation\nlet currentConversationId: string | null = null;\n\nfunction getCurrentConversationId(): string | null {\n  return currentConversationId;\n}\n\n// Handle messages from content script\nchrome.runtime.onMessage.addListener((message: ExtensionMessage | { type: 'WEBAPP_READY' }, sender) => {\n  console.log('[Claude Utils] Background received message:', message.type);\n\n  // Handle web app ready signal\n  if (message.type === 'WEBAPP_READY') {\n    if (sender.tab?.id) {\n      console.log('[Claude Utils] Web app tab ready:', sender.tab.id);\n      readyTabs.add(sender.tab.id);\n      flushPendingActivities(sender.tab.id);\n    }\n    return;\n  }\n\n  // Extract conversation ID from tab URL\n  if (sender.tab?.url) {\n    const match = sender.tab.url.match(/\\/chat\\/([^/?]+)/);\n    if (match) {\n      currentConversationId = match[1];\n    }\n  }\n\n  switch (message.type) {\n    case 'CLAUDE_RESPONSE':\n      processResponse(message.data);\n      break;\n    case 'DOM_ACTIVITY':\n      processDOMActivity(message.data);\n      break;\n    case 'CONVERSATION_TITLE':\n      conversationTitles.set(message.data.conversationId, message.data.title);\n      break;\n  }\n});\n\n// Clean up closed tabs\nchrome.tabs.onRemoved.addListener((tabId) => {\n  readyTabs.delete(tabId);\n});\n\nconsole.log('[Claude Utils] Background service worker initialized');\n"],"names":[],"mappings":"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"}